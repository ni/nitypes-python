name: Set up Poetry
description: Install Poetry and cache its installation.
inputs:
  poetry-version:
    default: 1.8.2
runs:
  using: composite
  steps:
    - name: Get Python version
      id: get-python-version
      run: |
        if [ ! -d "$pythonLocation" ]; then
          echo "You must use the setup-python action before using this action."
          exit 1
        fi 
        "$pythonLocation/python" -c "import platform; print(f'python-version={platform.python_version()}')" >> "$GITHUB_OUTPUT"
      shell: bash
    - name: Set paths
      id: set-paths
      run: |
        echo "POETRY_BIN_DIR=$HOME/.local/poetry/bin" >> "$GITHUB_ENV"
        echo "POETRY_HOME=$HOME/.local/poetry/venv" >> "$GITHUB_ENV"
        echo "poetry-bin-dir=$HOME/.local/poetry/bin" >> "$GITHUB_OUTPUT"
        echo "poetry-home=$HOME/.local/poetry/home" >> "$GITHUB_OUTPUT"
        echo "$HOME/.local/poetry/bin" >> "$GITHUB_PATH"
      shell: bash
    - name: Cache poetry
      id: cache-poetry
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: |
          ${{ steps.set-paths.outputs.poetry-bin-dir }}
          ${{ steps.set-paths.outputs.poetry-home }}
        key: poetry${{ inputs.poetry-version }}-${{ runner.os }}-py${{ steps.get-python-version.outputs.python-version }}
    - name: Install Poetry
      if: steps.cache-pipx.outputs.cache-hit != 'true'
      run: |
        "$pythonLocation/python" -m venv "$POETRY_HOME"
        if [ -d "$POETRY_HOME/Scripts" ]; then
          export POETRY_HOME_BIN="$POETRY_HOME/Scripts"
        else
          export POETRY_HOME_BIN="$POETRY_HOME/bin"
        fi
        "$POETRY_HOME_BIN/python" -m pip install poetry==${{ inputs.poetry-version }}
        mkdir -p "$POETRY_BIN_DIR"
        if [ -d "$POETRY_HOME/Scripts" ]; then
          cp "$POETRY_HOME_BIN/poetry.exe" "$POETRY_BIN_DIR/poetry.exe"
        else
          ln -s "$POETRY_HOME_BIN/poetry" "$POETRY_BIN_DIR/poetry"
        fi
      shell: bash
    - name: Print Poetry version
      run: poetry --version
      shell: bash